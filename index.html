<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>问卷</title>

<style>
body{
  margin:0;
  font-family:"Microsoft YaHei",Arial;
  background:#ffffff;
}
#screen{
  min-height:100vh;
  display:flex;
  align-items:center;
  justify-content:center;
}
.card{
  width:90%;
  max-width:800px;
  text-align:center;
}
.question{
  font-size:22px;
  line-height:1.8;
  margin-bottom:25px;
}
.option{
  border:1px solid #ddd;
  border-radius:12px;
  padding:14px;
  margin:10px 0;
  cursor:pointer;
}
.option:hover{
  background:#f3f3f3;
}
input{display:none;}
.error{color:red;}
button{
  padding:10px 20px;
  border:none;
  border-radius:10px;
  background:#222;
  color:#fff;
}
</style>
</head>

<body>

<div id="screen"></div>

<!-- 题库 -->
<script src="questionnaire.js"></script>

<script>

// ========= 防止脚本空白 =========
window.onerror = function(msg){
  document.getElementById("screen").innerHTML =
  "<div class='error'>脚本错误：<br>"+msg+
  "<br>请确认 questionnaire.js 是否成功加载</div>";
}

// ========= 题库检测 =========
const AQ =
  window.AQ_AdultScale__TimeLineVariables ||
  window.AQ_AdultScale_TimeLineVariables;

const EMOJI =
  window.EmojiUse_TimeLineVariables ||
  window.EmojiUse_TimeLineVariable;

if(!AQ || !Array.isArray(AQ)){
  document.getElementById("screen").innerHTML =
  "<div class='error'>找不到 AQ 题库</div>";
  throw "AQ missing";
}
if(!EMOJI || !Array.isArray(EMOJI)){
  document.getElementById("screen").innerHTML =
  "<div class='error'>找不到 Emoji 题库</div>";
  throw "Emoji missing";
}

// ========= 合并题目（不打乱） =========
const allTrials = [
  ...AQ.map(q=>({...q,scale:"AQ"})),
  ...EMOJI.map(q=>({...q,scale:"Emoji"}))
];

let index = 0;
let pid = "";
let data = [];
let t0 = 0;

// ========= CSV 下载 =========
function downloadCSV(){
  let header="pid,scale,itemID,question,response,score,rt\n";
  let rows = data.map(d =>
    [pid,d.scale,d.id,d.q,d.resp,d.score,d.rt]
    .map(x=>`"${x}"`).join(",")
  ).join("\n");

  let blob = new Blob([header+rows],{type:"text/csv"});
  let a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = pid+".csv";
  a.click();
}

// ========= 开始页 =========
function showPID(){
  screen.innerHTML=`
  <div class="card">
    <div class="question">请输入被试编号</div>
    <input id="pidInput" style="padding:10px">
    <br><br>
    <button onclick="start()">开始</button>
  </div>`;
}

function start(){
  pid=document.getElementById("pidInput").value.trim();
  if(!pid){alert("请输入编号");return;}
  nextTrial();
}

// ========= 显示题目 =========
function nextTrial(){
  if(index>=allTrials.length){
    finish();
    return;
  }

  let q = allTrials[index];
  t0 = performance.now();

  let options = q.OP1 ? [
    ["OP1",q.OP1],["OP2",q.OP2],
    ["OP3",q.OP3],["OP4",q.OP4],
    q.OP5?["OP5",q.OP5]:null
  ].filter(x=>x) :
  [
    ["OP1","完全同意"],
    ["OP2","少许同意"],
    ["OP3","少许不同意"],
    ["OP4","完全不同意"]
  ];

  screen.innerHTML=`
  <div class="card">
    <div class="question">${q.Question}</div>
    ${options.map(o=>`
      <div class="option" onclick="answer('${o[0]}')">
        ${o[1]}
      </div>
    `).join("")}
  </div>`;
}

// ========= 记录反应 =========
function answer(op){
  let q = allTrials[index];
  let rt = Math.round(performance.now()-t0);
  let score = q[op+"Score"] || "";

  data.push({
    scale:q.scale,
    id:q.ItemID,
    q:q.Question,
    resp:op,
    score:score,
    rt:rt
  });

  index++;
  nextTrial();
}

// ========= 结束 =========
function finish(){
  downloadCSV();
  screen.innerHTML=`
  <div class="card">
    <div class="question">问卷完成</div>
    <p>CSV 文件已自动保存</p>
    <p>请将文件发送给主试</p>
    <button onclick="downloadCSV()">重新下载</button>
  </div>`;
}

// ========= 启动 =========
const screen = document.getElementById("screen");
showPID();

</script>

</body>
</html>

<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>问卷</title>
  <style>
    body{
      margin:0; background:#fff;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI","PingFang SC","Microsoft YaHei",Arial,sans-serif;
      color:#111;
    }
    #screen{
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:18px;
      box-sizing:border-box;
    }
    .card{
      width:min(860px, 92vw);
      text-align:center;
      padding:10px;
    }
    .q{
      font-size:22px;
      line-height:1.8;
      margin: 8px 0 18px;
    }

    /* ✅ 横排选项容器（默认自动换行） */
    .opt-row{
      width:min(760px, 96vw);
      margin:10px auto 0;
      display:flex;
      flex-wrap:wrap;
      gap:12px 14px;
      justify-content:center;
      align-items:stretch;
    }

    /* ✅ 选项按钮（横排胶囊） */
    .opt{
      flex: 0 1 auto;
      min-width: 110px;       /* ✅ 让 5 个更容易一排 */
      max-width: 100%;
      padding: 12px 16px;
      border:1px solid #e5e5e5;
      border-radius: 999px;
      cursor:pointer;
      text-align:center;
      font-size:16px;
      user-select:none;
      background:#fff;
      box-sizing:border-box;
    }
    .opt:hover{ border-color:#cfcfcf; background:#fafafa; }

    /* ✅ 只有5点量表：强制五个一排（不换行） */
    .opt-row.five{
      flex-wrap: nowrap;
      gap: 12px;
    }
    .opt-row.five .opt{
      flex: 1 1 0;
      min-width: 0;
      padding: 12px 10px;
      font-size: 16px;
    }

    @media (max-width: 520px){
      .q{ font-size:20px; }
      .opt{ font-size:15px; padding:10px 12px; min-width: 100px; }
      .opt-row.five .opt{ font-size:14px; padding:10px 8px; }
    }

    .row{ display:flex; gap:10px; justify-content:center; flex-wrap:wrap; }
    input[type="text"]{
      padding:10px 12px; border:1px solid #ddd; border-radius:12px;
      width:240px; text-align:center; font-size:14px;
    }
    button{
      padding:10px 14px; border:0; border-radius:12px;
      background:#111827; color:#fff; cursor:pointer; font-size:14px;
    }
    button.secondary{
      background:#f3f4f6; color:#111; border:1px solid #e5e7eb;
    }
    .muted{ color:#666; font-size:14px; line-height:1.8; }
    .err{ color:#b91c1c; font-size:14px; line-height:1.7; }
  </style>
</head>
<body>
  <div id="screen"></div>

  <!-- ✅ 强制刷新缓存：你每次改 questionnaire.js 都把 v=1 改成 v=2/3/4 -->
  <script src="questionnaire.js?v=1"></script>

  <script>
    const screen = document.getElementById("screen");

    // 任何脚本错误直接显示在页面上（避免“空白”）
    window.addEventListener("error", (e) => {
      screen.innerHTML =
        "<div class='card'><div class='err'>页面脚本报错：<br>" +
        (e && e.message ? e.message : String(e)) +
        "<br><br>常见原因：questionnaire.js 没加载（404/大小写/路径）或文件里有语法错误。</div></div>";
    });

    // 题库读取（兼容你之前可能的变量名）
    const AQ =
      window.AQ_AdultScale__TimeLineVariables ||
      window.AQ_AdultScale_TimeLineVariables ||
      null;

    const EMOJI =
      window.EmojiUse_TimeLineVariables ||
      window.EmojiUse_TimeLineVariable ||
      null;

    if (!Array.isArray(AQ)) {
      screen.innerHTML =
        "<div class='card'><div class='err'>找不到 AQ 题库变量。<br>" +
        "请确认：<br>1）index.html 和 questionnaire.js 在同一个文件夹<br>" +
        "2）文件名大小写完全一致（questionnaire.js）</div></div>";
      throw new Error("AQ bank missing");
    }
    if (!Array.isArray(EMOJI)) {
      screen.innerHTML =
        "<div class='card'><div class='err'>找不到 Emoji 题库变量。请确认 questionnaire.js 里保留了 EmojiUse_TimeLineVariables。</div></div>";
      throw new Error("Emoji bank missing");
    }

    // ✅ 不随机：严格按你题库数组顺序呈现
    const trials = [
      ...AQ.map(x => ({...x, _scale:"AQ"})),
      ...EMOJI.map(x => ({...x, _scale:"Emoji"}))
    ];

    let pid = "";
    let idx = 0;
    let t0 = 0;
    const rows = [];

    function nowISO(){ return new Date().toISOString(); }

    function csvEscape(s){
      s = (s === undefined || s === null) ? "" : String(s);
      if (/[",\n\r]/.test(s)) return '"' + s.replace(/"/g,'""') + '"';
      return s;
    }

    function buildCSV(){
      const header = ["pid","scale","itemID","type","question","response","score","rt_ms","ts"];
      const lines = [header.join(",")];
      for(const r of rows){
        lines.push([
          r.pid, r.scale, r.itemID, r.type, r.question, r.response, r.score, r.rt_ms, r.ts
        ].map(csvEscape).join(","));
      }
      return lines.join("\n");
    }

    function downloadCSV(){
      const text = buildCSV();
      const blob = new Blob([text], {type:"text/csv;charset=utf-8"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      const stamp = new Date();
      const pad = (n)=>String(n).padStart(2,"0");
      const name = pid + "_" +
        stamp.getFullYear() + pad(stamp.getMonth()+1) + pad(stamp.getDate()) + "_" +
        pad(stamp.getHours()) + pad(stamp.getMinutes()) + pad(stamp.getSeconds()) +
        ".csv";
      a.href = url;
      a.download = name;
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(()=>URL.revokeObjectURL(url), 1000);
      return name;
    }

    function showPID(){
      screen.innerHTML = `
        <div class="card">
          <div class="q">请输入被试编号</div>
          <div class="row">
            <input id="pidInput" type="text" placeholder="PID">
            <button id="startBtn">开始</button>
          </div>
          <div class="err" id="err"></div>
          <div class="muted" style="margin-top:10px;">完成后在最后一页下载CSV并发送给主试。</div>
        </div>`;
      document.getElementById("startBtn").onclick = () => {
        const v = document.getElementById("pidInput").value.trim();
        if(!v){ document.getElementById("err").textContent = "编号不能为空"; return; }
        pid = v;
        idx = 0;
        rows.length = 0;
        next();
      };
    }

    function getOptions(item){
      const ops = [];
      for(let k=1;k<=6;k++){
        const key = "OP"+k;
        if(item[key] !== undefined) ops.push({key, text:item[key]});
      }
      if(ops.length) return ops; // Emoji：OP1..OP5
      return [                 // AQ：固定四选项（顺序不变）
        {key:"OP1", text:"完全同意"},
        {key:"OP2", text:"少许同意"},
        {key:"OP3", text:"少许不同意"},
        {key:"OP4", text:"完全不同意"}
      ];
    }

    function scoreOf(item, opKey){
      const v = item[opKey+"Score"];
      return (v === undefined || v === null) ? "" : String(v);
    }

    function next(){
      if(idx >= trials.length){
        finish();
        return;
      }
      const item = trials[idx];
      const ops = getOptions(item);
      t0 = performance.now();

      const isFive = (ops.length === 5); // ✅ 5个选项：强制一排
      screen.innerHTML = `
        <div class="card">
          <div class="q">${item.Question || ""}</div>
          <div class="opt-row ${isFive ? "five" : ""}">
            ${ops.map(o=>`<div class="opt" data-key="${o.key}">${o.text}</div>`).join("")}
          </div>
        </div>
      `;

      const optEls = screen.querySelectorAll(".opt");
      optEls.forEach(el=>{
        el.addEventListener("click", ()=>{
          const opKey = el.getAttribute("data-key");
          const rt = Math.round(performance.now() - t0);

          rows.push({
            pid,
            scale: item._scale,
            itemID: item.ItemID || "",
            type: item.Type || "",
            question: item.Question || "",
            response: opKey,
            score: scoreOf(item, opKey),
            rt_ms: String(rt),
            ts: nowISO()
          });

          idx += 1;
          next();
        });
      });
    }

    function finish(){
      screen.innerHTML = `
        <div class="card">
          <div class="q">问卷已完成</div>
          <div class="muted">请点击下方按钮下载CSV文件，并将文件发送给主试。</div>
          <div class="row" style="margin-top:16px;">
            <button id="dlBtn">下载CSV</button>
            <button class="secondary" id="dlBtn2">重新下载</button>
          </div>
          <div class="muted" id="fname" style="margin-top:10px;"></div>
        </div>
      `;
      const doDl = () => {
        const name = downloadCSV();
        document.getElementById("fname").textContent = "已生成文件：" + name + "（通常在下载/Downloads文件夹）";
      };
      document.getElementById("dlBtn").onclick = doDl;
      document.getElementById("dlBtn2").onclick = doDl;
    }

    showPID();
  </script>
</body>
</html>

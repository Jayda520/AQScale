<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AQ量表 + Emoji问卷</title>
  <style>
    body { margin:0; background:#f6f7fb; font-family: -apple-system,BlinkMacSystemFont,"Segoe UI","PingFang SC","Microsoft YaHei",Arial,sans-serif; }
    .wrap { max-width: 900px; margin: 0 auto; padding: 24px; }
    .card { background:#fff; border-radius: 14px; padding: 20px; box-shadow: 0 6px 20px rgba(0,0,0,.06); }
    h1 { margin:0 0 10px; font-size: 20px; }
    .muted { color:#666; font-size: 14px; line-height: 1.7; }
    .row { margin-top: 14px; display:flex; gap:10px; flex-wrap: wrap; align-items:center; }
    input[type="text"] { padding: 10px 12px; border:1px solid #ddd; border-radius: 10px; width: 220px; }
    button { padding: 10px 14px; border:0; border-radius: 10px; background:#111827; color:#fff; cursor:pointer; }
    button:disabled { opacity:.45; cursor:not-allowed; }
    .progress { margin-top: 10px; font-size: 14px; color:#333; }
    .q { font-size: 18px; line-height: 1.6; margin: 12px 0 14px; }
    .opts { display:grid; gap:10px; }
    label.opt { display:flex; align-items:center; gap:10px; border:1px solid #e5e7eb; padding: 12px; border-radius: 12px; cursor:pointer; }
    label.opt:hover { border-color:#cbd5e1; }
    .footer { margin-top: 14px; display:flex; gap:10px; justify-content: space-between; align-items:center; flex-wrap: wrap; }
    .err { color:#b91c1c; margin-top: 10px; }
    .ok { color:#15803d; margin-top: 10px; }
    .small { font-size: 12px; color:#666; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card" id="screen"></div>
  </div>

  <!-- 你的精简脚本：里面必须包含 sendData/sendData2 + AQ_AdultScale__TimeLineVariables + EmojiUse_TimeLineVariables -->
  <script src="questionnaire.js"></script>

  <script>
    // =========================
    // 纯前端问卷引擎（配合你的题库）
    // =========================
    function $(id){ return document.getElementById(id); }
    function nowISO(){ return new Date().toISOString(); }
    function safeStr(x){ return (x===undefined || x===null) ? "" : String(x); }

    // AQ 默认选项（因为 AQ 题库没有 OP1/OP2 文本）
    const AQ_DEFAULT_OPTIONS = [
      { key:"OP1", text:"完全同意" },
      { key:"OP2", text:"少许同意" },
      { key:"OP3", text:"少许不同意" },
      { key:"OP4", text:"完全不同意" }
    ];

    function extractOptions(item){
      const ops = [];
      for (let k=1; k<=6; k++){
        const key = "OP"+k;
        if (item[key] !== undefined) ops.push({ key, text: item[key] });
      }
      return ops.length ? ops : AQ_DEFAULT_OPTIONS;
    }

    function scoreOf(item, opKey){
      const s = item[opKey + "Score"];
      if (s === undefined) return null;
      const n = Number(s);
      return Number.isFinite(n) ? n : null;
    }

    class Runner{
      constructor(screenEl){
        this.el = screenEl;
        this.blocks = [];
        this.blockIndex = 0;
        this.itemIndex = 0;
        this.itemStartMs = 0;
        this.records = [];
        this.meta = {
          study: "AQ_Emoji",
          startTime: nowISO(),
          pid: "",
          ua: navigator.userAgent,
          page: location.href
        };
      }

      setBlocks(blocks){ this.blocks = blocks; }

      welcome(){
        this.el.innerHTML = `
          <h1>问卷开始</h1>
          <div class="muted">
            请认真作答。中途不要刷新页面。完成后会自动提交数据。<br>
            <span class="small">注意：如果页面是 https（如 GitHub Pages），而你的上传地址是 http，浏览器可能会拦截上传。</span>
          </div>
          <div class="row">
            <input id="pid" type="text" placeholder="请输入被试编号PID（必填）" />
            <button id="startBtn">开始</button>
          </div>
          <div class="err" id="err"></div>
        `;
        $("startBtn").onclick = () => {
          const pid = $("pid").value.trim();
          if(!pid){ $("err").textContent = "PID 不能为空。"; return; }
          this.meta.pid = pid;
          this.start();
        };
      }

      start(){
        this.blockIndex = 0;
        this.itemIndex = 0;
        this.records = [];
        this.renderItem();
      }

      renderItem(){
        const block = this.blocks[this.blockIndex];
        if(!block){ this.finish(); return; }

        const items = block.items;
        const item = items[this.itemIndex];
        if(!item){
          this.blockIndex += 1;
          this.itemIndex = 0;
          this.renderTransition();
          return;
        }

        const globalTotal = this.blocks.reduce((a,b)=>a+b.items.length,0);
        const done = this.blocks.slice(0,this.blockIndex).reduce((a,b)=>a+b.items.length,0) + this.itemIndex;

        const opts = extractOptions(item);
        this.itemStartMs = performance.now();

        this.el.innerHTML = `
          <h1>${block.name}</h1>
          <div class="progress">进度：${done+1} / ${globalTotal}</div>
          <div class="q"><b>${safeStr(item.ItemID)}</b> ${safeStr(item.Question)}</div>

          <div class="opts">
            ${opts.map(o=>`
              <label class="opt">
                <input type="radio" name="ans" value="${o.key}" />
                <span>${o.text}</span>
              </label>
            `).join("")}
          </div>

          <div class="footer">
            <div class="small">选一个选项后点击“下一题”</div>
            <button id="nextBtn" disabled>下一题</button>
          </div>

          <div class="err" id="err"></div>
        `;

        const radios = this.el.querySelectorAll('input[name="ans"]');
        radios.forEach(r=>r.addEventListener("change", ()=>{ $("nextBtn").disabled = false; }));

        $("nextBtn").onclick = () => {
          const chosen = this.el.querySelector('input[name="ans"]:checked');
          if(!chosen){ $("err").textContent = "请先选择一个选项。"; return; }

          const rt = Math.round(performance.now() - this.itemStartMs);
          const opKey = chosen.value;
          const score = scoreOf(item, opKey);
          const optionText = (opts.find(x=>x.key===opKey)||{}).text || "";

          this.records.push({
            pid: this.meta.pid,
            scale: block.name,
            itemID: safeStr(item.ItemID),
            type: safeStr(item.Type),
            question: safeStr(item.Question),
            response: opKey,
            responseText: optionText,
            score: score,
            rt_ms: rt,
            ts: nowISO()
          });

          this.itemIndex += 1;
          this.renderItem();
        };
      }

      renderTransition(){
        const nextBlock = this.blocks[this.blockIndex];
        if(!nextBlock){ this.finish(); return; }
        this.el.innerHTML = `
          <h1>下一部分</h1>
          <div class="muted">接下来进入：<b>${nextBlock.name}</b></div>
          <div class="row"><button id="goBtn">继续</button></div>
        `;
        $("goBtn").onclick = () => this.renderItem();
      }

      totals(){
        const t = {};
        for(const r of this.records){
          if(typeof r.score === "number" && Number.isFinite(r.score)){
            t[r.scale] = (t[r.scale] || 0) + r.score;
          }
        }
        return t;
      }

      finish(){
        const payload = {
          meta: { ...this.meta, endTime: nowISO() },
          totals: this.totals(),
          trials: this.records
        };

        this.el.innerHTML = `
          <h1>完成</h1>
          <div class="muted">感谢参与！正在提交数据…</div>
          <div class="ok" id="ok"></div>
          <div class="err" id="err"></div>
        `;

        try{
          // 这里默认用 sendData2，你想用 sendData 就改这一行
          if (typeof sendData2 !== "function") throw new Error("sendData2 未定义：请检查 questionnaire.js 是否加载成功");
          sendData2(payload);
          $("ok").textContent = "已发起上传请求（是否成功以服务器返回为准，可在控制台查看 responseText）。";
          console.log("UPLOAD_PAYLOAD", payload);
        }catch(e){
          console.error(e);
          $("err").textContent = "上传调用失败：" + (e && e.message ? e.message : String(e));
        }

        // 展示总分（可选）
        const totals = payload.totals || {};
        const lines = Object.entries(totals).map(([k,v])=>`<li>${k} 总分：${v}</li>`).join("");
        if(lines){
          this.el.innerHTML += `<ul style="margin-top:12px;">${lines}</ul>`;
        }
      }
    }

    // =========================
    // 启动：只跑 AQ + Emoji
    // =========================
    (function(){
      if (!Array.isArray(window.AQ_AdultScale__TimeLineVariables)) {
        $("screen").innerHTML = "<h1>错误</h1><div class='err'>找不到 AQ_AdultScale__TimeLineVariables，请确认 questionnaire.js 里保留了 AQ 题库。</div>";
        return;
      }
      if (!Array.isArray(window.EmojiUse_TimeLineVariables)) {
        $("screen").innerHTML = "<h1>错误</h1><div class='err'>找不到 EmojiUse_TimeLineVariables，请确认 questionnaire.js 里保留了 Emoji 题库。</div>";
        return;
      }

      const runner = new Runner($("screen"));
      runner.setBlocks([
        { name: "AQ", items: window.AQ_AdultScale__TimeLineVariables },
        { name: "EmojiUse", items: window.EmojiUse_TimeLineVariables }
      ]);
      runner.welcome();
    })();
  </script>
</body>
</html>
